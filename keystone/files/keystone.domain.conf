{% from "keystone/map.jinja" import server with context %}
{%- set domain = server.domain.get(domain_name) %}

{%- if domain.get("backend", "sql") == "ldap" %}

[ldap]
url = {{ domain.ldap.url }}
user = uid={{ domain.ldap.get("uid", "keystone") }},cn=users,cn=accounts,{{ domain.ldap.suffix }}
password = {{ domain.ldap.password }}
suffix = {{ domain.ldap.suffix }}

# User mapping
user_tree_dn = cn=users,cn=accounts,{{ domain.ldap.suffix }}
user_objectclass = person
user_id_attribute = uid
user_name_attribute = uid
user_mail_attribute = mail
{%- if domain.ldap.get('read_only', True) %}
user_allow_create = false
user_allow_update = false
user_allow_delete = false
{%- endif %}
user_enabled_attribute = nsAccountLock
user_enabled_default = False
user_enabled_invert = true
{%- if domain.ldap.get('filter', {}).get('user', False) %}
user_filter = {{ domain.ldap.filter.user }}
{%- endif %}

# Group mapping
group_tree_dn = cn=groups,cn=accounts,{{ domain.ldap.suffix }}
group_objectclass = groupOfNames
group_id_attribute = cn
group_name_attribute = cn
group_member_attribute = member
group_desc_attribute = description
{%- if domain.ldap.get('read_only', True) %}
group_allow_create = false
group_allow_update = false
group_allow_delete = false
{%- endif %}

{%- if domain.ldap.tls is defined %}

{%- if domain.ldap.tls.get("enabled", False) %}
use_tls = true
{%- endif %}

{%- if domain.ldap.tls.cacertdir is defined %}
tls_cacertdir = {{ domain.ldap.tls.cacertdir }}
{%- endif %}

{%- if domain.ldap.tls.cacert is defined %}
tls_cacertfile = /etc/keystone/domains/{{ domain_name }}.pem
{%- elif domain.ldap.tls.cacertfile is defined %}
tls_cacertfile = {{ domain.ldap.tls.cacertfile }}
{%- endif %}

{%- if domain.ldap.tls.req_cert is defined %}
tls_req_cert = {{ domain.ldap.tls.req_cert }}
{%- endif %}

{%- endif %}

{%- endif %}

[identity]
{%- if domain.get("backend", "sql") == "ldap" %}
driver = keystone.identity.backends.ldap.Identity
{%- else %}
driver = keystone.identity.backends.sql.Identity
{%- endif %}

[assignment]
{%- if domain.get("assignment", {}).get("backend", "sql") == "ldap" %}
driver = keystone.assignment.backends.ldap.Assignment
{%- else %}
driver = keystone.assignment.backends.sql.Assignment
{%- endif %}
